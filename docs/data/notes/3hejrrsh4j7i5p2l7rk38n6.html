<h1 id="2025-11-04-shared-logging-and-errorhandling">2025 11 04 Shared Logging and Errorhandling<a aria-hidden="true" class="anchor-heading icon-link" href="#2025-11-04-shared-logging-and-errorhandling"></a></h1>
<h2 id="prompt">Prompt<a aria-hidden="true" class="anchor-heading icon-link" href="#prompt"></a></h2>
<h1 id="semantic-flow-logging--error-handling-system-specification">Semantic Flow Logging &#x26; Error Handling System Specification<a aria-hidden="true" class="anchor-heading icon-link" href="#semantic-flow-logging--error-handling-system-specification"></a></h1>
<h2 id="nodejs-platform-rewrite">Node.js Platform Rewrite<a aria-hidden="true" class="anchor-heading icon-link" href="#nodejs-platform-rewrite"></a></h2>
<p><strong>Version:</strong> 1.0<br>
<strong>Date:</strong> November 4, 2025<br>
<strong>Status:</strong> Working Specification</p>
<hr>
<h2 id="overview">Overview<a aria-hidden="true" class="anchor-heading icon-link" href="#overview"></a></h2>
<p>This specification defines a streamlined, production-ready logging and error handling system for the Semantic Flow platform's Node.js rewrite. It consolidates the best features from the current Deno implementation while addressing identified redundancies and adding improvements for both CLI and service usage.</p>
<h3 id="design-goals">Design Goals<a aria-hidden="true" class="anchor-heading icon-link" href="#design-goals"></a></h3>
<ol>
<li><strong>Unified Architecture</strong>: Single system supporting both CLI tools and long-running services</li>
<li><strong>Simplified API</strong>: Eliminate redundant functions and streamline the interface  </li>
<li><strong>Enhanced Performance</strong>: Optimized for high-throughput service operations</li>
<li><strong>Better Developer Experience</strong>: Clear patterns, comprehensive documentation, and testing utilities</li>
<li><strong>Production Ready</strong>: Robust error recovery, monitoring, and observability features</li>
</ol>
<hr>
<h2 id="core-architecture">Core Architecture<a aria-hidden="true" class="anchor-heading icon-link" href="#core-architecture"></a></h2>
<h3 id="module-structure">Module Structure<a aria-hidden="true" class="anchor-heading icon-link" href="#module-structure"></a></h3>
<pre><code>src/logging/
├── core/
│   ├── logger.ts              # Main logger implementation
│   ├── types.ts               # Type definitions and interfaces
│   ├── formatters.ts          # Message formatting utilities
│   └── context.ts             # Context management and merging
├── channels/
│   ├── console.ts             # Console output channel
│   ├── file.ts                # File logging with rotation
│   └── monitoring.ts          # External monitoring (Sentry, etc.)
├── errors/
│   ├── capture.ts             # Error capture and logging
│   ├── recovery.ts            # Error recovery strategies  
│   ├── types.ts               # Error type definitions
│   └── factory.ts             # Error class factory utilities
├── config/
│   ├── loader.ts              # Configuration loading and validation
│   ├── schema.ts              # Configuration schema definitions
│   └── defaults.ts            # Default configurations
├── utils/
│   ├── context.ts             # AsyncLocalStorage context management
│   ├── performance.ts         # Performance monitoring utilities
│   ├── testing.ts             # Testing utilities and mocks
│   └── validation.ts          # Input validation helpers
└── index.ts                   # Main exports
</code></pre>
<hr>
<h2 id="type-system">Type System<a aria-hidden="true" class="anchor-heading icon-link" href="#type-system"></a></h2>
<h3 id="core-types">Core Types<a aria-hidden="true" class="anchor-heading icon-link" href="#core-types"></a></h3>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// Enhanced log levels with numeric values for easy comparison</span>
<span class="token keyword module">export</span> <span class="token keyword">enum</span> <span class="token maybe-class-name">LogLevel</span> <span class="token punctuation">{</span>
  <span class="token constant">TRACE</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token constant">DEBUG</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span>
  <span class="token constant">INFO</span> <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">,</span>
  <span class="token constant">WARN</span> <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">,</span>
  <span class="token constant">ERROR</span> <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">,</span>
  <span class="token constant">FATAL</span> <span class="token operator">=</span> <span class="token number">50</span>
<span class="token punctuation">}</span>

<span class="token comment">// String literals for configuration mapping</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token maybe-class-name">LogLevelStrings</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'trace'</span><span class="token punctuation">,</span> <span class="token string">'debug'</span><span class="token punctuation">,</span> <span class="token string">'info'</span><span class="token punctuation">,</span> <span class="token string">'warn'</span><span class="token punctuation">,</span> <span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token string">'fatal'</span><span class="token punctuation">]</span> <span class="token keyword module">as</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
<span class="token keyword module">export</span> <span class="token keyword">type</span> <span class="token class-name"><span class="token maybe-class-name">LogLevelString</span></span> <span class="token operator">=</span> <span class="token keyword">typeof</span> <span class="token maybe-class-name">LogLevelStrings</span><span class="token punctuation">[</span><span class="token builtin">number</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// Core log entry structure used throughout the system</span>
<span class="token keyword module">export</span> <span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">LogEntry</span></span> <span class="token punctuation">{</span>
  timestamp<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>                 <span class="token comment">// Date.now()</span>
  level<span class="token operator">:</span> <span class="token maybe-class-name">LogLevel</span><span class="token punctuation">;</span>
  message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  context<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span><span class="token punctuation">;</span>
  error<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    stack<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    code<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  service<span class="token operator">:</span> <span class="token punctuation">{</span> 
    name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span> 
    version<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span> 
    instanceId<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span> 
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  pid<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  hostname<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Comprehensive but streamlined log context</span>
<span class="token keyword module">export</span> <span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">LogContext</span></span> <span class="token punctuation">{</span>
  <span class="token comment">// Core identification</span>
  operation<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  operationId<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  component<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Semantic Flow specific context</span>
  meshId<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  nodeId<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  meshName<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  nodeName<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Performance tracking</span>
  startTime<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  duration<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  memoryUsage<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Request context (for service mode)</span>
  requestId<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  userId<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  sessionId<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Error context</span>
  errorCode<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  errorType<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  stackTrace<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  errorCause<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Flexible metadata</span>
  tags<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">Record</span><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token operator">></span><span class="token punctuation">;</span>
  metadata<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">Record</span><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">unknown</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Error capture options (for logging/reporting)</span>
<span class="token keyword module">export</span> <span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">ErrorCaptureOptions</span></span> <span class="token punctuation">{</span>
  message<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  context<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span><span class="token punctuation">;</span>
  logLevel<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">LogLevel</span><span class="token punctuation">;</span>
  includeStackTrace<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  reportToMonitoring<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Error recovery options (for control flow)</span>
<span class="token keyword module">export</span> <span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">ErrorRecoveryOptions</span><span class="token operator">&#x3C;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">unknown</span><span class="token operator">></span></span> <span class="token punctuation">{</span>
  strategy<span class="token operator">:</span> <span class="token maybe-class-name">ErrorRecoveryStrategy</span><span class="token punctuation">;</span>
  fallbackValue<span class="token operator">?</span><span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">;</span>
  retryCount<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  retryDelay<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  shouldRetry<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>error<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span> attempt<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Base log channel interface for extensibility</span>
<span class="token keyword module">export</span> <span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">LogChannel</span></span> <span class="token punctuation">{</span>
  <span class="token function">write</span><span class="token punctuation">(</span>entry<span class="token operator">:</span> <span class="token maybe-class-name">LogEntry</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token keyword">readonly</span> minLevel<span class="token operator">:</span> <span class="token maybe-class-name">LogLevel</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Channel configuration</span>
<span class="token keyword module">export</span> <span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">ChannelConfig</span></span> <span class="token punctuation">{</span>
  enabled<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  level<span class="token operator">:</span> <span class="token maybe-class-name">LogLevel</span><span class="token punctuation">;</span>
  format<span class="token operator">:</span> <span class="token string">'json'</span> <span class="token operator">|</span> <span class="token string">'pretty'</span> <span class="token operator">|</span> <span class="token string">'compact'</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Channel-specific options</span>
  <span class="token builtin">console</span><span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    colors<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
    timestamps<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  file<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    path<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    maxSize<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
    maxFiles<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
    rotationStrategy<span class="token operator">?</span><span class="token operator">:</span> <span class="token string">'time'</span> <span class="token operator">|</span> <span class="token string">'size'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  monitoring<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    provider<span class="token operator">:</span> <span class="token string">'sentry'</span> <span class="token operator">|</span> <span class="token string">'datadog'</span> <span class="token operator">|</span> <span class="token string">'newrelic'</span><span class="token punctuation">;</span>
    dsn<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    environment<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    sampleRate<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Main logger configuration</span>
<span class="token keyword module">export</span> <span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">LoggerConfig</span></span> <span class="token punctuation">{</span>
  serviceName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  serviceVersion<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  environment<span class="token operator">:</span> <span class="token string">'development'</span> <span class="token operator">|</span> <span class="token string">'staging'</span> <span class="token operator">|</span> <span class="token string">'production'</span><span class="token punctuation">;</span>
  instanceId<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Channel configurations</span>
  <span class="token builtin">console</span><span class="token operator">:</span> <span class="token maybe-class-name">ChannelConfig</span><span class="token punctuation">;</span>
  file<span class="token operator">:</span> <span class="token maybe-class-name">ChannelConfig</span><span class="token punctuation">;</span>
  monitoring<span class="token operator">:</span> <span class="token maybe-class-name">ChannelConfig</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Performance settings</span>
  async<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>        <span class="token comment">// true: buffered writes + sync stderr for ERROR/FATAL</span>
                        <span class="token comment">// false: synchronous writes where possible</span>
  bufferSize<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  flushInterval<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Context settings</span>
  autoContext<span class="token operator">:</span> <span class="token punctuation">{</span>
    includeTimestamp<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
    includeHostname<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
    includeProcessInfo<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="error-types">Error Types<a aria-hidden="true" class="anchor-heading icon-link" href="#error-types"></a></h3>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// Base error class with enhanced context</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token known-class-name class-name">SemanticFlowError</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token known-class-name class-name">Error</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">readonly</span> code<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">readonly</span> context<span class="token operator">:</span> <span class="token maybe-class-name">Record</span><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">unknown</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">readonly</span> timestamp<span class="token operator">:</span> <span class="token known-class-name class-name">Date</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">readonly</span> recoverable<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    code<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    context<span class="token operator">:</span> <span class="token maybe-class-name">Record</span><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">unknown</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    recoverable <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">name</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">constructor</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">code</span> <span class="token operator">=</span> code<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">context</span> <span class="token operator">=</span> context<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">timestamp</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">Date</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">recoverable</span> <span class="token operator">=</span> recoverable<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Error factory to reduce boilerplate</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">createErrorType</span><span class="token punctuation">(</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  code<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  recoverable <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> context<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">Record</span><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">unknown</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token known-class-name class-name">SemanticFlowError</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token keyword">extends</span></span> <span class="token known-class-name class-name">SemanticFlowError</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> context<span class="token operator">:</span> <span class="token maybe-class-name">Record</span><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">unknown</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> code<span class="token punctuation">,</span> context<span class="token punctuation">,</span> recoverable<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">name</span> <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Specific error types using factory</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token known-class-name class-name">ValidationError</span> <span class="token operator">=</span> <span class="token function">createErrorType</span><span class="token punctuation">(</span><span class="token string">'ValidationError'</span><span class="token punctuation">,</span> <span class="token string">'VALIDATION_ERROR'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token known-class-name class-name">ConfigurationError</span> <span class="token operator">=</span> <span class="token function">createErrorType</span><span class="token punctuation">(</span><span class="token string">'ConfigurationError'</span><span class="token punctuation">,</span> <span class="token string">'CONFIG_ERROR'</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token known-class-name class-name">MeshProcessingError</span> <span class="token operator">=</span> <span class="token function">createErrorType</span><span class="token punctuation">(</span><span class="token string">'MeshProcessingError'</span><span class="token punctuation">,</span> <span class="token string">'MESH_PROCESSING_ERROR'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token known-class-name class-name">ApiError</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token known-class-name class-name">SemanticFlowError</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">readonly</span> statusCode<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  
  <span class="token function">constructor</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> statusCode<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> context<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">Record</span><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">unknown</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token string">'API_ERROR'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">statusCode</span> <span class="token operator">=</span> statusCode<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<hr>
<h2 id="core-logger-interface">Core Logger Interface<a aria-hidden="true" class="anchor-heading icon-link" href="#core-logger-interface"></a></h2>
<h3 id="simplified-logger-api">Simplified Logger API<a aria-hidden="true" class="anchor-heading icon-link" href="#simplified-logger-api"></a></h3>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">export</span> <span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">Logger</span></span> <span class="token punctuation">{</span>
  <span class="token comment">// Core logging methods (synchronous with async buffering)</span>
  <span class="token function">trace</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> context<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token function">debug</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> context<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token function">info</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> context<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token function">warn</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> context<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token function">error</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> error<span class="token operator">?</span><span class="token operator">:</span> <span class="token known-class-name class-name">Error</span><span class="token punctuation">,</span> context<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token function">fatal</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> error<span class="token operator">?</span><span class="token operator">:</span> <span class="token known-class-name class-name">Error</span><span class="token punctuation">,</span> context<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Context management (returns immutable context wrappers)</span>
  <span class="token function">withContext</span><span class="token punctuation">(</span>context<span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Logger</span><span class="token punctuation">;</span>
  <span class="token function">withOperation</span><span class="token punctuation">(</span>operation<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> operationId<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Logger</span><span class="token punctuation">;</span>
  <span class="token function">withComponent</span><span class="token punctuation">(</span>component<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Logger</span><span class="token punctuation">;</span>
  <span class="token function">child</span><span class="token punctuation">(</span>context<span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Logger</span><span class="token punctuation">;</span> <span class="token comment">// Alias for withContext</span>
  
  <span class="token comment">// Performance tracking</span>
  <span class="token function">startTimer</span><span class="token punctuation">(</span>operation<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Timer</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Error capture (for logging/reporting only)</span>
  <span class="token function">captureError</span><span class="token punctuation">(</span>error<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span> options<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">ErrorCaptureOptions</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Lifecycle management</span>
  <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Child logger semantics documentation:</span>
<span class="token comment">// - child() returns a thin wrapper sharing transports and buffer with parent</span>
<span class="token comment">// - context is frozen and shallow-merged per call</span>
<span class="token comment">// - no mutation or context bleed between child instances</span>

<span class="token keyword module">export</span> <span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">Timer</span></span> <span class="token punctuation">{</span>
  <span class="token function">end</span><span class="token punctuation">(</span>context<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token function">checkpoint</span><span class="token punctuation">(</span>label<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> context<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="factory-functions">Factory Functions<a aria-hidden="true" class="anchor-heading icon-link" href="#factory-functions"></a></h3>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// Singleton pattern with dependency injection support</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">initLogger</span><span class="token punctuation">(</span>config<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">Partial</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">LoggerConfig</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">__resetLoggerForTests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>

<span class="token comment">// Factory functions for initialization</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">createLogger</span><span class="token punctuation">(</span>config<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">Partial</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">LoggerConfig</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">createCliLogger</span><span class="token punctuation">(</span>options<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  verbose<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  quiet<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  format<span class="token operator">?</span><span class="token operator">:</span> <span class="token string">'pretty'</span> <span class="token operator">|</span> <span class="token string">'json'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">createServiceLogger</span><span class="token punctuation">(</span>serviceName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> options<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  enableFileLogging<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  enableMonitoring<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  environment<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Logger</span><span class="token punctuation">;</span>

<span class="token comment">// Component-scoped logger (pure ESM)</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">getComponentLogger</span><span class="token punctuation">(</span>sourceUrl<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token comment">/* import.meta.url */</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Logger</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token constant">URL</span></span><span class="token punctuation">(</span>sourceUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> base <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token property-access">pathname</span><span class="token punctuation">.</span><span class="token method function property-access">split</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">??</span> <span class="token string">"unknown"</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> component <span class="token operator">=</span> base<span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(m|c)?js|ts$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">child</span><span class="token punctuation">(</span><span class="token punctuation">{</span> component <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<hr>
<h2 id="separated-error-handling">Separated Error Handling<a aria-hidden="true" class="anchor-heading icon-link" href="#separated-error-handling"></a></h2>
<h3 id="error-capture-loggingreporting">Error Capture (Logging/Reporting)<a aria-hidden="true" class="anchor-heading icon-link" href="#error-capture-loggingreporting"></a></h3>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// Pure error capture - only logs and reports, no control flow</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">captureError</span><span class="token punctuation">(</span>error<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span> options<span class="token operator">:</span> <span class="token maybe-class-name">ErrorCaptureOptions</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// Synchronous logging for ERROR/FATAL levels</span>
  <span class="token comment">// Async buffering for full reporting</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="error-recovery-control-flow">Error Recovery (Control Flow)<a aria-hidden="true" class="anchor-heading icon-link" href="#error-recovery-control-flow"></a></h3>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// Error recovery strategies (simplified)</span>
<span class="token keyword module">export</span> <span class="token keyword">enum</span> <span class="token maybe-class-name">ErrorRecoveryStrategy</span> <span class="token punctuation">{</span>
  <span class="token constant">CONTINUE</span> <span class="token operator">=</span> <span class="token string">'continue'</span><span class="token punctuation">,</span>        <span class="token comment">// Don't throw, continue execution</span>
  <span class="token constant">RETHROW</span> <span class="token operator">=</span> <span class="token string">'rethrow'</span><span class="token punctuation">,</span>         <span class="token comment">// Log then rethrow (default)</span>
  <span class="token constant">FALLBACK</span> <span class="token operator">=</span> <span class="token string">'fallback'</span><span class="token punctuation">,</span>       <span class="token comment">// Return fallback value</span>
  <span class="token constant">RETRY</span> <span class="token operator">=</span> <span class="token string">'retry'</span>              <span class="token comment">// Retry operation with backoff</span>
<span class="token punctuation">}</span>

<span class="token comment">// Apply recovery strategy to an error</span>
<span class="token keyword module">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">applyErrorRecovery</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>
  error<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span>
  options<span class="token operator">:</span> <span class="token maybe-class-name">ErrorRecoveryOptions</span><span class="token operator">&#x3C;</span><span class="token constant">T</span><span class="token operator">></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token constant">T</span> <span class="token operator">|</span> <span class="token builtin">never</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token comment">// Implementation handles retry logic, fallbacks, etc.</span>
<span class="token punctuation">}</span>

<span class="token comment">// Convenience wrapper combining capture + recovery</span>
<span class="token keyword module">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">withErrorHandling</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>
  <span class="token function-variable function">operation</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">,</span>
  options<span class="token operator">:</span> <span class="token punctuation">{</span>
    capture<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">ErrorCaptureOptions</span><span class="token punctuation">;</span>
    recovery<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">ErrorRecoveryOptions</span><span class="token operator">&#x3C;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token constant">T</span> <span class="token operator">|</span> <span class="token keyword nil">undefined</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword control-flow">await</span> <span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token property-access">capture</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">captureError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> options<span class="token punctuation">.</span><span class="token property-access">capture</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token property-access">recovery</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token keyword control-flow">await</span> <span class="token function">applyErrorRecovery</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> options<span class="token punctuation">.</span><span class="token property-access">recovery</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">throw</span> error<span class="token punctuation">;</span> <span class="token comment">// Default: rethrow</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="error-classification">Error Classification<a aria-hidden="true" class="anchor-heading icon-link" href="#error-classification"></a></h3>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">ErrorClassifier</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">classify</span><span class="token punctuation">(</span>error<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    severity<span class="token operator">:</span> <span class="token maybe-class-name">LogLevel</span><span class="token punctuation">;</span>
    recoverable<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
    category<span class="token operator">:</span> <span class="token string">'system'</span> <span class="token operator">|</span> <span class="token string">'business'</span> <span class="token operator">|</span> <span class="token string">'validation'</span> <span class="token operator">|</span> <span class="token string">'network'</span> <span class="token operator">|</span> <span class="token string">'unknown'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
  <span class="token keyword">static</span> <span class="token function">shouldReport</span><span class="token punctuation">(</span>error<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span> threshold<span class="token operator">:</span> <span class="token maybe-class-name">LogLevel</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token function">extractContext</span><span class="token punctuation">(</span>error<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Record</span><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">unknown</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<hr>
<h2 id="channel-implementations">Channel Implementations<a aria-hidden="true" class="anchor-heading icon-link" href="#channel-implementations"></a></h2>
<h3 id="console-channel">Console Channel<a aria-hidden="true" class="anchor-heading icon-link" href="#console-channel"></a></h3>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">ConsoleChannel</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">LogChannel</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">readonly</span> minLevel<span class="token operator">:</span> <span class="token maybe-class-name">LogLevel</span><span class="token punctuation">;</span>
  
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> config<span class="token operator">:</span> <span class="token maybe-class-name">ChannelConfig</span><span class="token punctuation">[</span><span class="token string">'console'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">minLevel</span> <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token property-access">level</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">write</span><span class="token punctuation">(</span>entry<span class="token operator">:</span> <span class="token maybe-class-name">LogEntry</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token comment">// Guard against entries below minimum level</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token property-access">level</span> <span class="token operator">&#x3C;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">minLevel</span><span class="token punctuation">)</span> <span class="token keyword control-flow">return</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Always synchronous for console - push async work to buffer</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token property-access">level</span> <span class="token operator">>=</span> <span class="token maybe-class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">ERROR</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">writeSynchronous</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">writeStandard</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment">// Console doesn't buffer, so flush is a no-op</span>
    <span class="token keyword control-flow">return</span> <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// Synchronous critical path for errors</span>
  <span class="token keyword">private</span> <span class="token function">writeSynchronous</span><span class="token punctuation">(</span>entry<span class="token operator">:</span> <span class="token maybe-class-name">LogEntry</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> line <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">formatCritical</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
      process<span class="token punctuation">.</span><span class="token property-access">stderr</span><span class="token punctuation">.</span><span class="token method function property-access">write</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">{</span>
      <span class="token comment">// Best effort - never throw from logging</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// Standard output for non-critical levels</span>
  <span class="token keyword">private</span> <span class="token function">writeStandard</span><span class="token punctuation">(</span>entry<span class="token operator">:</span> <span class="token maybe-class-name">LogEntry</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> line <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token property-access">stdout</span><span class="token punctuation">.</span><span class="token property-access">isTTY</span> 
      <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">formatForTTY</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span> 
      <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">formatForPipe</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
      process<span class="token punctuation">.</span><span class="token property-access">stdout</span><span class="token punctuation">.</span><span class="token method function property-access">write</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">{</span>
      <span class="token comment">// Best effort - never throw from logging</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// Smart formatting based on environment</span>
  <span class="token keyword">private</span> <span class="token function">formatForTTY</span><span class="token punctuation">(</span>entry<span class="token operator">:</span> <span class="token maybe-class-name">LogEntry</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token function">formatForPipe</span><span class="token punctuation">(</span>entry<span class="token operator">:</span> <span class="token maybe-class-name">LogEntry</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token function">formatCritical</span><span class="token punctuation">(</span>entry<span class="token operator">:</span> <span class="token maybe-class-name">LogEntry</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="file-channel">File Channel<a aria-hidden="true" class="anchor-heading icon-link" href="#file-channel"></a></h3>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">FileChannel</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">LogChannel</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">readonly</span> minLevel<span class="token operator">:</span> <span class="token maybe-class-name">LogLevel</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> buffer<span class="token operator">:</span> <span class="token maybe-class-name">LogEntry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> flushTimer<span class="token operator">:</span> <span class="token maybe-class-name">NodeJS</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Timer</span></span> <span class="token operator">|</span> <span class="token keyword null nil">null</span> <span class="token operator">=</span> <span class="token keyword null nil">null</span><span class="token punctuation">;</span>
  
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> config<span class="token operator">:</span> <span class="token maybe-class-name">ChannelConfig</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">minLevel</span> <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token property-access">level</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">write</span><span class="token punctuation">(</span>entry<span class="token operator">:</span> <span class="token maybe-class-name">LogEntry</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token comment">// Guard against entries below minimum level</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token property-access">level</span> <span class="token operator">&#x3C;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">minLevel</span><span class="token punctuation">)</span> <span class="token keyword control-flow">return</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Always async for file channel - add to buffer</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">buffer</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">scheduleFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// Single-flight flush to prevent concurrent flushes</span>
  <span class="token keyword">private</span> inflight<span class="token operator">?</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">;</span>
  
  <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">inflight</span> <span class="token operator">??</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">inflight</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">flushImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword control-flow">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">inflight</span> <span class="token operator">=</span> <span class="token keyword nil">undefined</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">flushTimer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">clearTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">flushTimer</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">flushTimer</span> <span class="token operator">=</span> <span class="token keyword null nil">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">flushBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// Enhanced rotation with compression and atomic operations</span>
  <span class="token keyword">private</span> <span class="token function">rotateIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">;</span> <span class="token comment">// Uses fs.rename for atomicity</span>
  <span class="token keyword">private</span> <span class="token function">compressOldLogs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token function">scheduleFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token function">flushImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">;</span> <span class="token comment">// Uses fs.writev for batched writes</span>
  
  <span class="token comment">// File opened with O_APPEND for safe concurrent writes</span>
  <span class="token comment">// Reopen file descriptor after rotation</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="monitoring-channel">Monitoring Channel<a aria-hidden="true" class="anchor-heading icon-link" href="#monitoring-channel"></a></h3>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">MonitoringChannel</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">LogChannel</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">readonly</span> minLevel<span class="token operator">:</span> <span class="token maybe-class-name">LogLevel</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> buffer<span class="token operator">:</span> <span class="token maybe-class-name">LogEntry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> rateLimiter<span class="token operator">:</span> <span class="token maybe-class-name">RateLimiter</span><span class="token punctuation">;</span>
  
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> config<span class="token operator">:</span> <span class="token maybe-class-name">ChannelConfig</span><span class="token punctuation">[</span><span class="token string">'monitoring'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">minLevel</span> <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token property-access">level</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">rateLimiter</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">RateLimiter</span></span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token property-access">sampleRate</span> <span class="token operator">||</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">write</span><span class="token punctuation">(</span>entry<span class="token operator">:</span> <span class="token maybe-class-name">LogEntry</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token comment">// Guard against entries below minimum level</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token property-access">level</span> <span class="token operator">&#x3C;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">minLevel</span><span class="token punctuation">)</span> <span class="token keyword control-flow">return</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Apply sampling and rate limiting</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">shouldSample</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword control-flow">return</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Always async for monitoring - add to buffer with timeout protection</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">buffer</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">scheduleFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// Single-flight flush to prevent concurrent monitoring flushes</span>
  <span class="token keyword">private</span> inflight<span class="token operator">?</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">;</span>
  
  <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">inflight</span> <span class="token operator">??</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">inflight</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">flushImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword control-flow">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">inflight</span> <span class="token operator">=</span> <span class="token keyword nil">undefined</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">flushWithTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// Provider-specific implementations</span>
  <span class="token keyword">private</span> sentryAdapter<span class="token operator">:</span> <span class="token maybe-class-name">SentryAdapter</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> datadogAdapter<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">DatadogAdapter</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Smart sampling and rate limiting with timeout protection</span>
  <span class="token keyword">private</span> <span class="token function">shouldSample</span><span class="token punctuation">(</span>entry<span class="token operator">:</span> <span class="token maybe-class-name">LogEntry</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token function">scheduleFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token function">flushImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">;</span> <span class="token comment">// Bounds batch size and applies per-entry deadlines</span>
  
  <span class="token comment">// Drop counter for monitoring timeouts/failures</span>
  <span class="token keyword">private</span> droppedCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token function">getDroppedCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span> <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">droppedCount</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Missing primitive definitions</span>
<span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">RateLimiter</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> rate<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">allow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span> <span class="token keyword control-flow">return</span> <span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&#x3C;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">rate</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">SentryAdapter</span></span> <span class="token punctuation">{</span>
  <span class="token function">send</span><span class="token punctuation">(</span>entry<span class="token operator">:</span> <span class="token maybe-class-name">LogEntry</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">DatadogAdapter</span></span> <span class="token punctuation">{</span>
  <span class="token function">send</span><span class="token punctuation">(</span>entry<span class="token operator">:</span> <span class="token maybe-class-name">LogEntry</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<hr>
<h2 id="configuration-system">Configuration System<a aria-hidden="true" class="anchor-heading icon-link" href="#configuration-system"></a></h2>
<h3 id="async-flag-semantics">Async Flag Semantics<a aria-hidden="true" class="anchor-heading icon-link" href="#async-flag-semantics"></a></h3>
<p>The <code>async</code> configuration flag controls write behavior:</p>
<ul>
<li><strong><code>async: true</code></strong> (default): Non-blocking buffered writes for all channels. ERROR/FATAL levels also emit synchronously to <code>process.stderr</code> for immediate visibility.</li>
<li><strong><code>async: false</code></strong>: Console and file channels use <code>writeSync</code> on ERROR/FATAL and best-effort synchronous writes for other levels. Monitoring channel remains buffered with best-effort flush. <strong>Warning</strong>: Synchronous I/O can impact performance significantly under load.</li>
</ul>
<h3 id="schema-based-configuration">Schema-Based Configuration<a aria-hidden="true" class="anchor-heading icon-link" href="#schema-based-configuration"></a></h3>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// JSON Schema for logger configuration</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token maybe-class-name">LoggerConfigSchema</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">'object'</span><span class="token punctuation">,</span>
  properties<span class="token operator">:</span> <span class="token punctuation">{</span>
    serviceName<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> minLength<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    serviceVersion<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'string'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    environment<span class="token operator">:</span> <span class="token punctuation">{</span> 
      type<span class="token operator">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> 
      <span class="token keyword">enum</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'development'</span><span class="token punctuation">,</span> <span class="token string">'staging'</span><span class="token punctuation">,</span> <span class="token string">'production'</span><span class="token punctuation">]</span> 
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token builtin">console</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'object'</span><span class="token punctuation">,</span>
      properties<span class="token operator">:</span> <span class="token punctuation">{</span>
        enabled<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'boolean'</span><span class="token punctuation">,</span> <span class="token keyword module">default</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        level<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> <span class="token keyword">enum</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'trace'</span><span class="token punctuation">,</span> <span class="token string">'debug'</span><span class="token punctuation">,</span> <span class="token string">'info'</span><span class="token punctuation">,</span> <span class="token string">'warn'</span><span class="token punctuation">,</span> <span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token string">'fatal'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        format<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> <span class="token keyword">enum</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'json'</span><span class="token punctuation">,</span> <span class="token string">'pretty'</span><span class="token punctuation">,</span> <span class="token string">'compact'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    file<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'object'</span><span class="token punctuation">,</span>
      properties<span class="token operator">:</span> <span class="token punctuation">{</span>
        enabled<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'boolean'</span><span class="token punctuation">,</span> <span class="token keyword module">default</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        level<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> <span class="token keyword">enum</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'trace'</span><span class="token punctuation">,</span> <span class="token string">'debug'</span><span class="token punctuation">,</span> <span class="token string">'info'</span><span class="token punctuation">,</span> <span class="token string">'warn'</span><span class="token punctuation">,</span> <span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token string">'fatal'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        format<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> <span class="token keyword">enum</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'json'</span><span class="token punctuation">,</span> <span class="token string">'pretty'</span><span class="token punctuation">,</span> <span class="token string">'compact'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        path<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'string'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        maxSize<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'number'</span><span class="token punctuation">,</span> minimum<span class="token operator">:</span> <span class="token number">1024</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        maxFiles<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'number'</span><span class="token punctuation">,</span> minimum<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        rotationStrategy<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> <span class="token keyword">enum</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'time'</span><span class="token punctuation">,</span> <span class="token string">'size'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    monitoring<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'object'</span><span class="token punctuation">,</span>
      properties<span class="token operator">:</span> <span class="token punctuation">{</span>
        enabled<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'boolean'</span><span class="token punctuation">,</span> <span class="token keyword module">default</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        level<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> <span class="token keyword">enum</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'trace'</span><span class="token punctuation">,</span> <span class="token string">'debug'</span><span class="token punctuation">,</span> <span class="token string">'info'</span><span class="token punctuation">,</span> <span class="token string">'warn'</span><span class="token punctuation">,</span> <span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token string">'fatal'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        provider<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> <span class="token keyword">enum</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'sentry'</span><span class="token punctuation">,</span> <span class="token string">'datadog'</span><span class="token punctuation">,</span> <span class="token string">'newrelic'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        dsn<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'string'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        environment<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'string'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        sampleRate<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'number'</span><span class="token punctuation">,</span> minimum<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> maximum<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  required<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'serviceName'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Configuration loader with multiple sources</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">ConfigLoader</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">load</span><span class="token punctuation">(</span>sources<span class="token operator">:</span> <span class="token punctuation">{</span>
    defaults<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">Partial</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">LoggerConfig</span><span class="token operator">></span><span class="token punctuation">;</span>
    configFile<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    environment<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">Record</span><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token operator">></span><span class="token punctuation">;</span>
    cliArgs<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">Record</span><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">unknown</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">LoggerConfig</span><span class="token punctuation">;</span>
  
  <span class="token keyword">static</span> <span class="token function">validate</span><span class="token punctuation">(</span>config<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">LoggerConfig</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token function">merge</span><span class="token punctuation">(</span><span class="token spread operator">...</span>configs<span class="token operator">:</span> <span class="token maybe-class-name">Partial</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">LoggerConfig</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">LoggerConfig</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Map string level names to enum values</span>
  <span class="token keyword">static</span> <span class="token function">parseLogLevel</span><span class="token punctuation">(</span>level<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">LogLevel</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> index <span class="token operator">=</span> <span class="token maybe-class-name">LogLevelStrings</span><span class="token punctuation">.</span><span class="token method function property-access">indexOf</span><span class="token punctuation">(</span>level <span class="token keyword module">as</span> <span class="token maybe-class-name">LogLevelString</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> index <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token punctuation">(</span>index <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword module">as</span> <span class="token maybe-class-name">LogLevel</span> <span class="token operator">:</span> <span class="token maybe-class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">INFO</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="environment-variable-mapping">Environment Variable Mapping<a aria-hidden="true" class="anchor-heading icon-link" href="#environment-variable-mapping"></a></h3>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># Service identification</span>
<span class="token assign-left variable">SF_SERVICE_NAME</span><span class="token operator">=</span>semantic-flow-service
<span class="token assign-left variable">SF_SERVICE_VERSION</span><span class="token operator">=</span><span class="token number">2.0</span>.0
<span class="token assign-left variable">SF_ENVIRONMENT</span><span class="token operator">=</span>production

<span class="token comment"># Console logging</span>
<span class="token assign-left variable">SF_LOG_CONSOLE_ENABLED</span><span class="token operator">=</span>true
<span class="token assign-left variable">SF_LOG_CONSOLE_LEVEL</span><span class="token operator">=</span>info
<span class="token assign-left variable">SF_LOG_CONSOLE_FORMAT</span><span class="token operator">=</span>pretty

<span class="token comment"># File logging  </span>
<span class="token assign-left variable">SF_LOG_FILE_ENABLED</span><span class="token operator">=</span>true
<span class="token assign-left variable">SF_LOG_FILE_PATH</span><span class="token operator">=</span>./logs/sf-service.log
<span class="token assign-left variable">SF_LOG_FILE_LEVEL</span><span class="token operator">=</span>debug
<span class="token assign-left variable">SF_LOG_FILE_MAX_SIZE</span><span class="token operator">=</span><span class="token number">10485760</span>
<span class="token assign-left variable">SF_LOG_FILE_MAX_FILES</span><span class="token operator">=</span><span class="token number">5</span>

<span class="token comment"># Monitoring</span>
<span class="token assign-left variable">SF_LOG_MONITORING_ENABLED</span><span class="token operator">=</span>true
<span class="token assign-left variable">SF_LOG_MONITORING_PROVIDER</span><span class="token operator">=</span>sentry
<span class="token assign-left variable">SF_LOG_MONITORING_DSN</span><span class="token operator">=</span>https://<span class="token punctuation">..</span>.
<span class="token assign-left variable">SF_LOG_MONITORING_SAMPLE_RATE</span><span class="token operator">=</span><span class="token number">0.1</span>
</code></pre>
<hr>
<h2 id="context-management">Context Management<a aria-hidden="true" class="anchor-heading icon-link" href="#context-management"></a></h2>
<h3 id="asynclocalstorage-integration">AsyncLocalStorage Integration<a aria-hidden="true" class="anchor-heading icon-link" href="#asynclocalstorage-integration"></a></h3>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// Automatic context propagation using Node.js AsyncLocalStorage</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">ContextManager</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> als <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">AsyncLocalStorage</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">LogContext</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">static</span> <span class="token generic-function"><span class="token function">run</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>context<span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span><span class="token punctuation">,</span> <span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">als</span><span class="token punctuation">.</span><span class="token method function property-access">run</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">static</span> <span class="token generic-function"><span class="token function">runAsync</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>context<span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span><span class="token punctuation">,</span> <span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">als</span><span class="token punctuation">.</span><span class="token method function property-access">run</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">static</span> <span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span> <span class="token operator">|</span> <span class="token keyword nil">undefined</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">als</span><span class="token punctuation">.</span><span class="token method function property-access">getStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">static</span> <span class="token function">merge</span><span class="token punctuation">(</span>context<span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> current <span class="token operator">?</span> <span class="token punctuation">{</span> <span class="token spread operator">...</span>current<span class="token punctuation">,</span> <span class="token spread operator">...</span>context <span class="token punctuation">}</span> <span class="token operator">:</span> context<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// HTTP middleware integration (framework-agnostic example)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> randomUUID <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'node:crypto'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">createRequestLogger</span><span class="token punctuation">(</span>
  req<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span> method<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span> path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span> <span class="token function">get</span><span class="token punctuation">(</span>header<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword nil">undefined</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  res<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span>
  <span class="token function-variable function">next</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">void</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> requestContext<span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    operation<span class="token operator">:</span> <span class="token string">'http-request'</span><span class="token punctuation">,</span>
    requestId<span class="token operator">:</span> req<span class="token punctuation">.</span><span class="token property-access">id</span> <span class="token operator">||</span> <span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    metadata<span class="token operator">:</span> <span class="token punctuation">{</span>
      method<span class="token operator">:</span> req<span class="token punctuation">.</span><span class="token property-access">method</span><span class="token punctuation">,</span>
      path<span class="token operator">:</span> req<span class="token punctuation">.</span><span class="token property-access">path</span><span class="token punctuation">,</span>
      userAgent<span class="token operator">:</span> req<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'User-Agent'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
  <span class="token maybe-class-name">ContextManager</span><span class="token punctuation">.</span><span class="token method function property-access">run</span><span class="token punctuation">(</span>requestContext<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>req <span class="token keyword module">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">logger</span> <span class="token operator">=</span> <span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">child</span><span class="token punctuation">(</span><span class="token punctuation">{</span> component<span class="token operator">:</span> <span class="token string">'http-handler'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<hr>
<h2 id="performance-enhancements">Performance Enhancements<a aria-hidden="true" class="anchor-heading icon-link" href="#performance-enhancements"></a></h2>
<h3 id="async-logging-with-buffering">Async Logging with Buffering<a aria-hidden="true" class="anchor-heading icon-link" href="#async-logging-with-buffering"></a></h3>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AsyncLogBuffer</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> buffer<span class="token operator">:</span> <span class="token maybe-class-name">LogEntry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> flushTimer<span class="token operator">:</span> <span class="token maybe-class-name">NodeJS</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Timer</span></span> <span class="token operator">|</span> <span class="token keyword null nil">null</span> <span class="token operator">=</span> <span class="token keyword null nil">null</span><span class="token punctuation">;</span>
  
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> maxSize<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">,</span>
    <span class="token keyword">private</span> flushInterval<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">5000</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  
  <span class="token function">add</span><span class="token punctuation">(</span>entry<span class="token operator">:</span> <span class="token maybe-class-name">LogEntry</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token function">autoFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="performance-monitoring">Performance Monitoring<a aria-hidden="true" class="anchor-heading icon-link" href="#performance-monitoring"></a></h3>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">PerformanceTracker</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token generic-function"><span class="token function">trackOperation</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>
    operation<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    <span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">,</span>
    logger<span class="token operator">:</span> <span class="token maybe-class-name">Logger</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">;</span>
  
  <span class="token keyword">static</span> <span class="token function">createTimer</span><span class="token punctuation">(</span>operation<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> logger<span class="token operator">:</span> <span class="token maybe-class-name">Logger</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Timer</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Memory usage tracking</span>
  <span class="token keyword">static</span> <span class="token function">trackMemory</span><span class="token punctuation">(</span>logger<span class="token operator">:</span> <span class="token maybe-class-name">Logger</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Log volume metrics  </span>
  <span class="token keyword">static</span> <span class="token function">getLogMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    totalLogs<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
    logsByLevel<span class="token operator">:</span> <span class="token maybe-class-name">Record</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">LogLevel</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token operator">></span><span class="token punctuation">;</span>
    errorRate<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
    avgResponseTime<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<hr>
<h2 id="testing-utilities">Testing Utilities<a aria-hidden="true" class="anchor-heading icon-link" href="#testing-utilities"></a></h2>
<h3 id="mock-logger">Mock Logger<a aria-hidden="true" class="anchor-heading icon-link" href="#mock-logger"></a></h3>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">MockLogger</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">Logger</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> logs<span class="token operator">:</span> <span class="token maybe-class-name">LogEntry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> capturedErrors<span class="token operator">:</span> <span class="token known-class-name class-name">Array</span><span class="token operator">&#x3C;</span><span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">;</span> options<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">ErrorCaptureOptions</span> <span class="token punctuation">}</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Implement all Logger methods with recording</span>
  <span class="token function">trace</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> context<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token function">debug</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> context<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token function">info</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> context<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token function">warn</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> context<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token function">error</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> error<span class="token operator">?</span><span class="token operator">:</span> <span class="token known-class-name class-name">Error</span><span class="token punctuation">,</span> context<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token function">fatal</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> error<span class="token operator">?</span><span class="token operator">:</span> <span class="token known-class-name class-name">Error</span><span class="token punctuation">,</span> context<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  
  <span class="token function">captureError</span><span class="token punctuation">(</span>error<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span> options<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">ErrorCaptureOptions</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">capturedErrors</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token punctuation">,</span> options <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Also create a log entry for the error</span>
    <span class="token keyword">const</span> entry<span class="token operator">:</span> <span class="token maybe-class-name">LogEntry</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      timestamp<span class="token operator">:</span> <span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      level<span class="token operator">:</span> options<span class="token operator">?.</span>logLevel <span class="token operator">||</span> <span class="token maybe-class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">ERROR</span><span class="token punctuation">,</span>
      message<span class="token operator">:</span> options<span class="token operator">?.</span>message <span class="token operator">||</span> <span class="token punctuation">(</span>error <span class="token keyword">instanceof</span> <span class="token class-name"><span class="token known-class-name class-name">Error</span></span> <span class="token operator">?</span> error<span class="token punctuation">.</span><span class="token property-access">message</span> <span class="token operator">:</span> <span class="token known-class-name class-name">String</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      context<span class="token operator">:</span> options<span class="token operator">?.</span>context<span class="token punctuation">,</span>
      error<span class="token operator">:</span> error <span class="token keyword">instanceof</span> <span class="token class-name"><span class="token known-class-name class-name">Error</span></span> <span class="token operator">?</span> <span class="token punctuation">{</span>
        name<span class="token operator">:</span> error<span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">,</span>
        message<span class="token operator">:</span> error<span class="token punctuation">.</span><span class="token property-access">message</span><span class="token punctuation">,</span>
        stack<span class="token operator">:</span> error<span class="token punctuation">.</span><span class="token property-access">stack</span><span class="token operator">?.</span><span class="token method function property-access">split</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        code<span class="token operator">:</span> <span class="token punctuation">(</span>error <span class="token keyword module">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">code</span>
      <span class="token punctuation">}</span> <span class="token operator">:</span> <span class="token keyword nil">undefined</span><span class="token punctuation">,</span>
      service<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'test-service'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      pid<span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token property-access">pid</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">logs</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// Test utilities</span>
  <span class="token function">findLogsByLevel</span><span class="token punctuation">(</span>level<span class="token operator">:</span> <span class="token maybe-class-name">LogLevel</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">LogEntry</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">findLogsByComponent</span><span class="token punctuation">(</span>component<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">LogEntry</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">findLogsByOperation</span><span class="token punctuation">(</span>operation<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">LogEntry</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">hasErrorWithCode</span><span class="token punctuation">(</span>code<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token function">clearLogs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">logs</span><span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">capturedErrors</span><span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">LoggerTestUtils</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">createMockLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">MockLogger</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token function">createTestConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">LoggerConfig</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token function">waitForLogs</span><span class="token punctuation">(</span>logger<span class="token operator">:</span> <span class="token maybe-class-name">MockLogger</span><span class="token punctuation">,</span> count<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> timeout<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="integration-test-helpers">Integration Test Helpers<a aria-hidden="true" class="anchor-heading icon-link" href="#integration-test-helpers"></a></h3>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">LoggerIntegrationTests</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">testFileRotation</span><span class="token punctuation">(</span>config<span class="token operator">:</span> <span class="token maybe-class-name">LoggerConfig</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">TestResult</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">testErrorHandling</span><span class="token punctuation">(</span>config<span class="token operator">:</span> <span class="token maybe-class-name">LoggerConfig</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">TestResult</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">testPerformance</span><span class="token punctuation">(</span>config<span class="token operator">:</span> <span class="token maybe-class-name">LoggerConfig</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">PerformanceResult</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">testMonitoringIntegration</span><span class="token punctuation">(</span>config<span class="token operator">:</span> <span class="token maybe-class-name">LoggerConfig</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">TestResult</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<hr>
<h2 id="usage-examples">Usage Examples<a aria-hidden="true" class="anchor-heading icon-link" href="#usage-examples"></a></h2>
<h3 id="cli-tool-usage">CLI Tool Usage<a aria-hidden="true" class="anchor-heading icon-link" href="#cli-tool-usage"></a></h3>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> createCliLogger<span class="token punctuation">,</span> getComponentLogger <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@semantic-flow/logging'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">createCliLogger</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
  verbose<span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token property-access">argv</span><span class="token punctuation">.</span><span class="token method function property-access">includes</span><span class="token punctuation">(</span><span class="token string">'--verbose'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  format<span class="token operator">:</span> <span class="token string">'pretty'</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Component-scoped logger using import.meta.url</span>
<span class="token keyword">const</span> componentLogger <span class="token operator">=</span> <span class="token function">getComponentLogger</span><span class="token punctuation">(</span><span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">processFiles</span><span class="token punctuation">(</span>files<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> timer <span class="token operator">=</span> componentLogger<span class="token punctuation">.</span><span class="token method function property-access">startTimer</span><span class="token punctuation">(</span><span class="token string">'process-files'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
    componentLogger<span class="token punctuation">.</span><span class="token method function property-access">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Processing </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>files<span class="token punctuation">.</span><span class="token property-access">length</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> files</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> file <span class="token keyword">of</span> files<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> fileLogger <span class="token operator">=</span> componentLogger<span class="token punctuation">.</span><span class="token method function property-access">withContext</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
        operation<span class="token operator">:</span> <span class="token string">'process-file'</span><span class="token punctuation">,</span>
        metadata<span class="token operator">:</span> <span class="token punctuation">{</span> filename<span class="token operator">:</span> file <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token keyword control-flow">await</span> <span class="token function">processFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> fileLogger<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    timer<span class="token punctuation">.</span><span class="token method function property-access">end</span><span class="token punctuation">(</span><span class="token punctuation">{</span> metadata<span class="token operator">:</span> <span class="token punctuation">{</span> filesProcessed<span class="token operator">:</span> files<span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">captureError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      message<span class="token operator">:</span> <span class="token string">'Failed to process files'</span><span class="token punctuation">,</span>
      context<span class="token operator">:</span> <span class="token punctuation">{</span> metadata<span class="token operator">:</span> <span class="token punctuation">{</span> files <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      reportToMonitoring<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">throw</span> error<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="service-usage">Service Usage<a aria-hidden="true" class="anchor-heading icon-link" href="#service-usage"></a></h3>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> createServiceLogger<span class="token punctuation">,</span> getComponentLogger<span class="token punctuation">,</span> <span class="token maybe-class-name">ContextManager</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@semantic-flow/logging'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">createServiceLogger</span><span class="token punctuation">(</span><span class="token string">'semantic-flow-api'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  enableFileLogging<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  enableMonitoring<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  environment<span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Component-specific logger for this module</span>
<span class="token keyword">const</span> componentLogger <span class="token operator">=</span> <span class="token function">getComponentLogger</span><span class="token punctuation">(</span><span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> requestContext <span class="token operator">=</span> <span class="token punctuation">{</span>
    operation<span class="token operator">:</span> <span class="token string">'api-request'</span><span class="token punctuation">,</span>
    requestId<span class="token operator">:</span> req<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">,</span>
    metadata<span class="token operator">:</span> <span class="token punctuation">{</span>
      method<span class="token operator">:</span> req<span class="token punctuation">.</span><span class="token property-access">method</span><span class="token punctuation">,</span>
      path<span class="token operator">:</span> req<span class="token punctuation">.</span><span class="token property-access">path</span><span class="token punctuation">,</span>
      userAgent<span class="token operator">:</span> req<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'User-Agent'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
  <span class="token maybe-class-name">ContextManager</span><span class="token punctuation">.</span><span class="token method function property-access">run</span><span class="token punctuation">(</span>requestContext<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    req<span class="token punctuation">.</span><span class="token property-access">logger</span> <span class="token operator">=</span> componentLogger<span class="token punctuation">.</span><span class="token method function property-access">child</span><span class="token punctuation">(</span><span class="token punctuation">{</span> component<span class="token operator">:</span> <span class="token string">'http-handler'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="error-handling">Error Handling<a aria-hidden="true" class="anchor-heading icon-link" href="#error-handling"></a></h3>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> captureError<span class="token punctuation">,</span> withErrorHandling<span class="token punctuation">,</span> <span class="token maybe-class-name">ErrorRecoveryStrategy</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@semantic-flow/logging'</span><span class="token punctuation">;</span>

<span class="token comment">// Simple error capture (logging only)</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">riskyOperation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">await</span> <span class="token function">doSomethingRisky</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">captureError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      message<span class="token operator">:</span> <span class="token string">'Risky operation failed'</span><span class="token punctuation">,</span>
      context<span class="token operator">:</span> <span class="token punctuation">{</span> operation<span class="token operator">:</span> <span class="token string">'risky-op'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      includeStackTrace<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Continue with fallback logic</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Combined error handling with recovery</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">withErrorHandling</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">callExternalAPI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    capture<span class="token operator">:</span> <span class="token punctuation">{</span>
      context<span class="token operator">:</span> <span class="token punctuation">{</span> operation<span class="token operator">:</span> <span class="token string">'external-api-call'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      reportToMonitoring<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    recovery<span class="token operator">:</span> <span class="token punctuation">{</span>
      strategy<span class="token operator">:</span> <span class="token maybe-class-name">ErrorRecoveryStrategy</span><span class="token punctuation">.</span><span class="token constant">RETRY</span><span class="token punctuation">,</span>
      retryCount<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
      fallbackValue<span class="token operator">:</span> <span class="token keyword null nil">null</span><span class="token punctuation">,</span>
      retryDelay<span class="token operator">:</span> <span class="token number">1000</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// AsyncLocalStorage context propagation with ESM</span>
<span class="token keyword">const</span> componentLogger <span class="token operator">=</span> <span class="token function">getComponentLogger</span><span class="token punctuation">(</span><span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token maybe-class-name">ContextManager</span><span class="token punctuation">.</span><span class="token method function property-access">runAsync</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span> operation<span class="token operator">:</span> <span class="token string">'batch-process'</span><span class="token punctuation">,</span> userId<span class="token operator">:</span> <span class="token string">'user123'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// All logging within this scope automatically includes the context</span>
    componentLogger<span class="token punctuation">.</span><span class="token method function property-access">info</span><span class="token punctuation">(</span><span class="token string">'Starting batch process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Automatically includes operation + userId + component</span>
    
    <span class="token keyword control-flow">await</span> <span class="token function">processItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    componentLogger<span class="token punctuation">.</span><span class="token method function property-access">info</span><span class="token punctuation">(</span><span class="token string">'Batch process completed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Dynamic import example for configuration loading</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">loadConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> configModule <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./config.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> configModule<span class="token punctuation">.</span><span class="token keyword module">default</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">captureError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      message<span class="token operator">:</span> <span class="token string">'Failed to load configuration module'</span><span class="token punctuation">,</span>
      context<span class="token operator">:</span> <span class="token punctuation">{</span> operation<span class="token operator">:</span> <span class="token string">'config-load'</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">throw</span> error<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<hr>
<h2 id="migration-guide">Migration Guide<a aria-hidden="true" class="anchor-heading icon-link" href="#migration-guide"></a></h2>
<h3 id="from-deno-implementation">From Deno Implementation<a aria-hidden="true" class="anchor-heading icon-link" href="#from-deno-implementation"></a></h3>
<ol>
<li><strong>Logger Initialization</strong>: Use <code>initLogger()</code> at startup, then <code>getLogger()</code> or <code>getComponentLogger(import.meta.url)</code> anywhere</li>
<li><strong>Error Handling</strong>: Replace both <code>handleError</code> and <code>handleCaughtError</code> with <code>captureError()</code> + optional recovery</li>
<li><strong>Configuration</strong>: Use schema-based config with singleton pattern</li>
<li><strong>Context Management</strong>: Use <code>AsyncLocalStorage</code> for automatic context propagation</li>
<li><strong>Async Methods</strong>: All logging methods are synchronous (with internal async buffering)</li>
<li><strong>Context Creation</strong>: Use immutable <code>child()</code> loggers instead of mutable context updates</li>
</ol>
<h3 id="breaking-changes">Breaking Changes<a aria-hidden="true" class="anchor-heading icon-link" href="#breaking-changes"></a></h3>
<ul>
<li>Log levels changed to enum with numeric values</li>
<li>Context merging behavior simplified</li>
<li>File rotation configuration consolidated</li>
<li>Sentry integration moved to generic monitoring channel</li>
</ul>
<hr>
<h2 id="implementation-plan">Implementation Plan<a aria-hidden="true" class="anchor-heading icon-link" href="#implementation-plan"></a></h2>
<h3 id="phase-1-core-infrastructure-week-1-2">Phase 1: Core Infrastructure (Week 1-2)<a aria-hidden="true" class="anchor-heading icon-link" href="#phase-1-core-infrastructure-week-1-2"></a></h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled> Type definitions and interfaces</li>
<li class="task-list-item"><input type="checkbox" disabled> Basic logger implementation</li>
<li class="task-list-item"><input type="checkbox" disabled> Console channel implementation</li>
<li class="task-list-item"><input type="checkbox" disabled> Configuration system</li>
<li class="task-list-item"><input type="checkbox" disabled> Unit tests for core functionality</li>
</ul>
<h3 id="phase-2-advanced-features-week-3-4">Phase 2: Advanced Features (Week 3-4)<a aria-hidden="true" class="anchor-heading icon-link" href="#phase-2-advanced-features-week-3-4"></a></h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled> File channel with rotation</li>
<li class="task-list-item"><input type="checkbox" disabled> Monitoring channel (Sentry)</li>
<li class="task-list-item"><input type="checkbox" disabled> Unified error handling</li>
<li class="task-list-item"><input type="checkbox" disabled> Performance tracking</li>
<li class="task-list-item"><input type="checkbox" disabled> Integration tests</li>
</ul>
<h3 id="phase-3-cliservice-integration-week-5">Phase 3: CLI/Service Integration (Week 5)<a aria-hidden="true" class="anchor-heading icon-link" href="#phase-3-cliservice-integration-week-5"></a></h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled> CLI logger factory</li>
<li class="task-list-item"><input type="checkbox" disabled> Service logger factory  </li>
<li class="task-list-item"><input type="checkbox" disabled> Context management utilities</li>
<li class="task-list-item"><input type="checkbox" disabled> Documentation and examples</li>
</ul>
<h3 id="phase-4-testing--documentation-week-6">Phase 4: Testing &#x26; Documentation (Week 6)<a aria-hidden="true" class="anchor-heading icon-link" href="#phase-4-testing--documentation-week-6"></a></h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled> Comprehensive test suite</li>
<li class="task-list-item"><input type="checkbox" disabled> Performance benchmarks</li>
<li class="task-list-item"><input type="checkbox" disabled> Migration documentation</li>
<li class="task-list-item"><input type="checkbox" disabled> API documentation</li>
</ul>
<h4 id="detailed-test-plan">Detailed Test Plan<a aria-hidden="true" class="anchor-heading icon-link" href="#detailed-test-plan"></a></h4>
<p><strong>Core Functionality Tests:</strong></p>
<ul>
<li><strong>Deterministic clocks</strong>: Inject <code>now()</code> function into logger; use Vitest fake timers for predictable timestamps</li>
<li><strong>Rotation tests</strong>: Force size-based rotation with tiny <code>maxSize</code>; assert new file created and file descriptor reopened</li>
<li><strong>Signal tests</strong>: Simulate SIGINT/SIGTERM with child process; assert <code>flush()</code> called before exit</li>
<li><strong>No-throw contract</strong>: Intentionally throw inside a channel's <code>write</code> method; ensure logger falls back to console and does not crash caller</li>
<li><strong>ESM component detection</strong>: Test <code>getComponentLogger(import.meta.url)</code> with various file paths and extensions</li>
</ul>
<p><strong>Advanced Feature Tests:</strong></p>
<ul>
<li><strong>Monitoring timeouts</strong>: Stub adapter with delayed promise; assert drop counters increment when deadlines exceeded</li>
<li><strong>ALS propagation</strong>: Assert <code>ContextManager.current()</code> context merged into log entries across <code>await</code> points</li>
<li><strong>Recursive logging protection</strong>: Trigger error within logging code; verify fallback to console.error without infinite loops</li>
<li><strong>Back-pressure handling</strong>: Fill buffers beyond capacity; verify graceful degradation and dropped message counts</li>
<li><strong>Pure ESM integrity</strong>: Verify no <code>require()</code> calls in bundled output; test dynamic import usage</li>
</ul>
<hr>
<h2 id="success-criteria">Success Criteria<a aria-hidden="true" class="anchor-heading icon-link" href="#success-criteria"></a></h2>
<ol>
<li><strong>Performance</strong>: 50% faster than current Deno implementation</li>
<li><strong>Memory Usage</strong>: 30% lower memory footprint</li>
<li><strong>API Simplicity</strong>: 40% fewer public methods/functions</li>
<li><strong>Test Coverage</strong>: 95% code coverage</li>
<li><strong>Documentation</strong>: Complete API docs and usage examples</li>
<li><strong>Migration</strong>: Clear migration path from Deno version</li>
</ol>
<hr>
<h2 id="production-considerations">Production Considerations<a aria-hidden="true" class="anchor-heading icon-link" href="#production-considerations"></a></h2>
<h3 id="json-lines-output-format">JSON Lines Output Format<a aria-hidden="true" class="anchor-heading icon-link" href="#json-lines-output-format"></a></h3>
<p>All structured log output follows the JSON Lines format (newline-delimited JSON) for ingestion by log processors like FluentBit, Loki, or Elasticsearch:</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// Each log entry is a single JSON object terminated by \n</span>
<span class="token punctuation">{</span><span class="token string-property property">"timestamp"</span><span class="token operator">:</span><span class="token number">1699027200000</span><span class="token punctuation">,</span><span class="token string-property property">"level"</span><span class="token operator">:</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token string-property property">"message"</span><span class="token operator">:</span><span class="token string">"Server started"</span><span class="token punctuation">,</span><span class="token string-property property">"service"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string-property property">"name"</span><span class="token operator">:</span><span class="token string">"api"</span><span class="token punctuation">,</span><span class="token string-property property">"version"</span><span class="token operator">:</span><span class="token string">"1.0.0"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string-property property">"pid"</span><span class="token operator">:</span><span class="token number">12345</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string-property property">"timestamp"</span><span class="token operator">:</span><span class="token number">1699027201000</span><span class="token punctuation">,</span><span class="token string-property property">"level"</span><span class="token operator">:</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token string-property property">"message"</span><span class="token operator">:</span><span class="token string">"Database connection failed"</span><span class="token punctuation">,</span><span class="token string-property property">"error"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string-property property">"name"</span><span class="token operator">:</span><span class="token string">"Error"</span><span class="token punctuation">,</span><span class="token string-property property">"message"</span><span class="token operator">:</span><span class="token string">"Connection timeout"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string-property property">"service"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string-property property">"name"</span><span class="token operator">:</span><span class="token string">"api"</span><span class="token punctuation">,</span><span class="token string-property property">"version"</span><span class="token operator">:</span><span class="token string">"1.0.0"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string-property property">"pid"</span><span class="token operator">:</span><span class="token number">12345</span><span class="token punctuation">}</span>
</code></pre>
<h3 id="flush-guarantees">Flush Guarantees<a aria-hidden="true" class="anchor-heading icon-link" href="#flush-guarantees"></a></h3>
<p>The <code>flush()</code> method provides the following guarantees:</p>
<ul>
<li>Drains buffers of all enabled channels within a bounded time (default 5s timeout)</li>
<li>Never throws - errors are logged to console as fallback</li>
<li>Returns when all pending entries are written or timeout is reached</li>
<li>Safe to call multiple times concurrently</li>
</ul>
<h3 id="critical-path-reliability">Critical Path Reliability<a aria-hidden="true" class="anchor-heading icon-link" href="#critical-path-reliability"></a></h3>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// Synchronous logging for ERROR/FATAL ensures immediate output</span>
<span class="token keyword">function</span> <span class="token function">logSyncCritical</span><span class="token punctuation">(</span>entry<span class="token operator">:</span> <span class="token maybe-class-name">LogEntry</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> line <span class="token operator">=</span> <span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    t<span class="token operator">:</span> entry<span class="token punctuation">.</span><span class="token property-access">timestamp</span><span class="token punctuation">,</span>
    lvl<span class="token operator">:</span> entry<span class="token punctuation">.</span><span class="token property-access">level</span><span class="token punctuation">,</span>
    msg<span class="token operator">:</span> entry<span class="token punctuation">.</span><span class="token property-access">message</span><span class="token punctuation">,</span>
    rid<span class="token operator">:</span> entry<span class="token punctuation">.</span><span class="token property-access">context</span><span class="token operator">?.</span>requestId
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">;</span>
  
  <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span> 
    process<span class="token punctuation">.</span><span class="token property-access">stderr</span><span class="token punctuation">.</span><span class="token method function property-access">write</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">{</span>
    <span class="token comment">// Never throw from logging - best effort only</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// Optional: Synchronous file write for critical errors</span>
  <span class="token comment">// if (criticalFd) fs.writeSync(criticalFd, line);</span>
<span class="token punctuation">}</span>

<span class="token comment">// Safe JSON serialization with limits and circular protection</span>
<span class="token keyword">const</span> <span class="token constant">MAX_CTX</span> <span class="token operator">=</span> <span class="token number">20_000</span><span class="token punctuation">,</span> <span class="token constant">MAX_MSG</span> <span class="token operator">=</span> <span class="token number">2_000</span><span class="token punctuation">,</span> <span class="token constant">MAX_STACK</span> <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">safeStringify</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> maxLength <span class="token operator">=</span> <span class="token constant">MAX_CTX</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> seen <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">WeakSet</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> val <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&#x26;&#x26;</span> val <span class="token operator">!==</span> <span class="token keyword null nil">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>seen<span class="token punctuation">.</span><span class="token method function property-access">has</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword control-flow">return</span> <span class="token string">'[Circular]'</span><span class="token punctuation">;</span>
        seen<span class="token punctuation">.</span><span class="token method function property-access">add</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> val <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">&#x26;&#x26;</span> val<span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">></span> <span class="token constant">MAX_MSG</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">return</span> val<span class="token punctuation">.</span><span class="token method function property-access">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">MAX_MSG</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'...[truncated]'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword control-flow">return</span> val<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> result<span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">></span> maxLength <span class="token operator">?</span> result<span class="token punctuation">.</span><span class="token method function property-access">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> maxLength<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'...[truncated]'</span> <span class="token operator">:</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token string">'[Unserializable]'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Strip ANSI escape codes for non-TTY output</span>
<span class="token keyword">function</span> <span class="token function">stripAnsi</span><span class="token punctuation">(</span>text<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> text<span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\x1b\[[0-9;]*m</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// PII redaction hook (optional per channel)</span>
<span class="token keyword">type</span> <span class="token class-name"><span class="token maybe-class-name">RedactFn</span></span> <span class="token operator">=</span> <span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token builtin">any</span><span class="token punctuation">;</span>
<span class="token keyword">type</span> <span class="token class-name"><span class="token maybe-class-name">RedactConfig</span></span> <span class="token operator">=</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token maybe-class-name">RedactFn</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">applyRedaction</span><span class="token punctuation">(</span>entry<span class="token operator">:</span> <span class="token maybe-class-name">LogEntry</span><span class="token punctuation">,</span> redact<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">RedactConfig</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">LogEntry</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>redact<span class="token punctuation">)</span> <span class="token keyword control-flow">return</span> entry<span class="token punctuation">;</span>
  
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token known-class-name class-name">Array</span><span class="token punctuation">.</span><span class="token method function property-access">isArray</span><span class="token punctuation">(</span>redact<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Field-based redaction</span>
    <span class="token keyword">const</span> redactFields <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">Set</span></span><span class="token punctuation">(</span>redact<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> <span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">parse</span><span class="token punctuation">(</span><span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token arrow operator">=></span> 
      redactFields<span class="token punctuation">.</span><span class="token method function property-access">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'[REDACTED]'</span> <span class="token operator">:</span> value
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Custom redaction function</span>
    <span class="token keyword control-flow">return</span> <span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">parse</span><span class="token punctuation">(</span><span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> redact<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Ensure JSON lines contain no ANSI codes</span>
<span class="token keyword">function</span> <span class="token function">formatJsonLine</span><span class="token punctuation">(</span>entry<span class="token operator">:</span> <span class="token maybe-class-name">LogEntry</span><span class="token punctuation">,</span> redact<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">RedactConfig</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> redacted <span class="token operator">=</span> <span class="token function">applyRedaction</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> redact<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> serialized <span class="token operator">=</span> <span class="token function">safeStringify</span><span class="token punctuation">(</span>redacted<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token function">stripAnsi</span><span class="token punctuation">(</span>serialized<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="graceful-shutdown">Graceful Shutdown<a aria-hidden="true" class="anchor-heading icon-link" href="#graceful-shutdown"></a></h3>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> <span class="token constant">SAFE_CLOSE_MS</span> <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">;</span>

<span class="token comment">// Comprehensive process termination hooks</span>
process<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'beforeExit'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">await</span> <span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

process<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'SIGTERM'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">void</span> <span class="token function">gracefulExit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'SIGINT'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">void</span> <span class="token function">gracefulExit</span><span class="token punctuation">(</span><span class="token number">130</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

process<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'uncaughtException'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// Sync-log minimal line to stderr first</span>
  <span class="token keyword">const</span> line <span class="token operator">=</span> <span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    t<span class="token operator">:</span> <span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    lvl<span class="token operator">:</span> <span class="token maybe-class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">FATAL</span><span class="token punctuation">,</span>
    msg<span class="token operator">:</span> <span class="token string">'Uncaught exception - process terminating'</span><span class="token punctuation">,</span>
    err<span class="token operator">:</span> error<span class="token punctuation">.</span><span class="token property-access">message</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span> process<span class="token punctuation">.</span><span class="token property-access">stderr</span><span class="token punctuation">.</span><span class="token method function property-access">write</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  
  <span class="token comment">// Then capture full error context</span>
  <span class="token function">captureError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span> 
    logLevel<span class="token operator">:</span> <span class="token maybe-class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">FATAL</span><span class="token punctuation">,</span>
    message<span class="token operator">:</span> <span class="token string">'Uncaught exception - process terminating'</span><span class="token punctuation">,</span>
    includeStackTrace<span class="token operator">:</span> <span class="token boolean">true</span> 
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">gracefulExit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

process<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'unhandledRejection'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">captureError</span><span class="token punctuation">(</span>reason <span class="token keyword module">as</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> 
    logLevel<span class="token operator">:</span> <span class="token maybe-class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">ERROR</span><span class="token punctuation">,</span>
    message<span class="token operator">:</span> <span class="token string">'Unhandled promise rejection'</span><span class="token punctuation">,</span>
    includeStackTrace<span class="token operator">:</span> <span class="token boolean">true</span> 
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">safeGetLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Logger</span> <span class="token operator">|</span> <span class="token keyword nil">undefined</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword nil">undefined</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">gracefulExit</span><span class="token punctuation">(</span>code<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">safeGetLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Race between proper close and timeout</span>
      <span class="token keyword control-flow">await</span> <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        logger<span class="token punctuation">.</span><span class="token method function property-access">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">Promise</span></span><span class="token punctuation">(</span>resolve <span class="token arrow operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token constant">SAFE_CLOSE_MS</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">{</span>
    <span class="token comment">// Best effort - don't block exit</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">finally</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span><span class="token method function property-access">exit</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="guard-against-recursive-logging">Guard Against Recursive Logging<a aria-hidden="true" class="anchor-heading icon-link" href="#guard-against-recursive-logging"></a></h3>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// Use AsyncLocalStorage to prevent recursive logging per async context</span>
<span class="token keyword">const</span> recursionGuard <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">AsyncLocalStorage</span><span class="token operator">&#x3C;</span><span class="token builtin">boolean</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">LoggerImpl</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">Logger</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token function">log</span><span class="token punctuation">(</span>level<span class="token operator">:</span> <span class="token maybe-class-name">LogLevel</span><span class="token punctuation">,</span> message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> error<span class="token operator">?</span><span class="token operator">:</span> <span class="token known-class-name class-name">Error</span><span class="token punctuation">,</span> context<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>recursionGuard<span class="token punctuation">.</span><span class="token method function property-access">getStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Prevent infinite loops in error handling - use direct console</span>
      <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span><span class="token string">'Recursive logging detected:'</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword control-flow">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    recursionGuard<span class="token punctuation">.</span><span class="token method function property-access">run</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">writeToChannels</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> message<span class="token punctuation">,</span> error<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">trace</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> context<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token maybe-class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">TRACE</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> <span class="token keyword nil">undefined</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">debug</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> context<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token maybe-class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">DEBUG</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> <span class="token keyword nil">undefined</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">info</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> context<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token maybe-class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">INFO</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> <span class="token keyword nil">undefined</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">warn</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> context<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token maybe-class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">WARN</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> <span class="token keyword nil">undefined</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">error</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> error<span class="token operator">?</span><span class="token operator">:</span> <span class="token known-class-name class-name">Error</span><span class="token punctuation">,</span> context<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token maybe-class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">ERROR</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> error<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">fatal</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> error<span class="token operator">?</span><span class="token operator">:</span> <span class="token known-class-name class-name">Error</span><span class="token punctuation">,</span> context<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token maybe-class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">FATAL</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> error<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">private</span> <span class="token function">writeToChannels</span><span class="token punctuation">(</span>level<span class="token operator">:</span> <span class="token maybe-class-name">LogLevel</span><span class="token punctuation">,</span> message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> error<span class="token operator">?</span><span class="token operator">:</span> <span class="token known-class-name class-name">Error</span><span class="token punctuation">,</span> context<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">LogContext</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token comment">// Implementation that might trigger errors and recursive logging</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<hr>
<h2 id="understanding-error-recovery-strategies">Understanding Error Recovery Strategies<a aria-hidden="true" class="anchor-heading icon-link" href="#understanding-error-recovery-strategies"></a></h2>
<p>Error recovery strategies control <strong>what happens after an error is logged</strong>, not the logging itself:</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// Example: Processing a batch of files</span>
<span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> file <span class="token keyword">of</span> files<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">await</span> <span class="token function">withErrorHandling</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">processFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      capture<span class="token operator">:</span> <span class="token punctuation">{</span> 
        message<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Failed to process </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        context<span class="token operator">:</span> <span class="token punctuation">{</span> operation<span class="token operator">:</span> <span class="token string">'file-processing'</span><span class="token punctuation">,</span> filename<span class="token operator">:</span> file <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      recovery<span class="token operator">:</span> <span class="token punctuation">{</span>
        strategy<span class="token operator">:</span> <span class="token maybe-class-name">ErrorRecoveryStrategy</span><span class="token punctuation">.</span><span class="token constant">CONTINUE</span><span class="token punctuation">,</span> <span class="token comment">// Keep processing other files</span>
        <span class="token comment">// Don't let one bad file stop the whole batch</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Example: Critical database connection</span>
<span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">withErrorHandling</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">connectToDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    capture<span class="token operator">:</span> <span class="token punctuation">{</span>
      message<span class="token operator">:</span> <span class="token string">'Database connection failed'</span><span class="token punctuation">,</span>
      reportToMonitoring<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    recovery<span class="token operator">:</span> <span class="token punctuation">{</span>
      strategy<span class="token operator">:</span> <span class="token maybe-class-name">ErrorRecoveryStrategy</span><span class="token punctuation">.</span><span class="token constant">RETRY</span><span class="token punctuation">,</span>
      retryCount<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
      retryDelay<span class="token operator">:</span> <span class="token number">2000</span><span class="token punctuation">,</span>
      <span class="token comment">// Keep trying - app can't work without DB</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Example: Optional feature that might fail</span>
<span class="token keyword">const</span> userPreferences <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">withErrorHandling</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">loadUserPreferences</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    capture<span class="token operator">:</span> <span class="token punctuation">{</span>
      message<span class="token operator">:</span> <span class="token string">'Failed to load user preferences'</span><span class="token punctuation">,</span>
      context<span class="token operator">:</span> <span class="token punctuation">{</span> userId <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    recovery<span class="token operator">:</span> <span class="token punctuation">{</span>
      strategy<span class="token operator">:</span> <span class="token maybe-class-name">ErrorRecoveryStrategy</span><span class="token punctuation">.</span><span class="token constant">FALLBACK</span><span class="token punctuation">,</span>
      fallbackValue<span class="token operator">:</span> <span class="token constant">DEFAULT_PREFERENCES</span><span class="token punctuation">,</span>
      <span class="token comment">// App works fine with defaults</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<hr>
<h2 id="questions-for-review">Questions for Review<a aria-hidden="true" class="anchor-heading icon-link" href="#questions-for-review"></a></h2>
<ol>
<li>Should error recovery strategies be pluggable?</li>
</ol>
<hr>
<h2 id="future-enhancements-v2">Future Enhancements (v2+)<a aria-hidden="true" class="anchor-heading icon-link" href="#future-enhancements-v2"></a></h2>
<p>Items suggested in review but deferred for initial implementation:</p>
<ol>
<li><strong>Plugin Architecture</strong>: <code>logger.use(plugin)</code> for extensible middleware</li>
<li><strong>Circuit Breaker</strong>: Automatic monitoring channel fallback during outages  </li>
<li><strong>ErrorClassifier Registry</strong>: Pluggable error classification rules</li>
<li><strong>Advanced Performance Tracking</strong>: Built-in metrics collection and analysis</li>
<li><strong>Log Event Streaming</strong>: Global event emitter for real-time log processing</li>
<li><strong>Pluggable Formatters</strong>: Custom format registration system</li>
<li><strong>Advanced Context Features</strong>: Structured event fields, correlation IDs</li>
<li><strong>Log Compression</strong>: Automatic compression of rotated log files</li>
<li><strong>Source Location Capture</strong>: Optional <code>file</code>, <code>line</code>, <code>col</code> fields from stack traces in debug builds</li>
<li><strong>Custom Formatters</strong>: <code>registerFormatter(name, fn)</code> for pluggable output formats beyond json/pretty/compact</li>
</ol>
<p>These features can be added incrementally based on usage patterns and requirements.</p>
<h3 id="nice-to-have-before-v1">Nice-to-Have Before v1<a aria-hidden="true" class="anchor-heading icon-link" href="#nice-to-have-before-v1"></a></h3>
<ul>
<li><strong>Monitoring Timeouts</strong>: Per-entry deadlines and token-bucket rate limiting for monitoring channels</li>
<li><strong>Enhanced Error Context</strong>: Automatic source location capture in development mode</li>
<li><strong>Advanced Sampling</strong>: Intelligent sampling based on error patterns and frequency</li>
</ul>
<hr>
<h2 id="critical-review-summary">Critical Review Summary<a aria-hidden="true" class="anchor-heading icon-link" href="#critical-review-summary"></a></h2>
<p><strong>ChatGPT's feedback addressed key architectural issues:</strong></p>
<p>✅ <strong>Fixed</strong>: Async/sync API inconsistency<br>
✅ <strong>Fixed</strong>: Split error handling into capture + recovery concerns<br>
✅ <strong>Fixed</strong>: Added LogChannel interface for extensibility<br>
✅ <strong>Fixed</strong>: Added synchronous critical path for ERROR/FATAL<br>
✅ <strong>Fixed</strong>: Added AsyncLocalStorage for context propagation<br>
✅ <strong>Fixed</strong>: Added singleton pattern with DI support<br>
✅ <strong>Added</strong>: Error class factory to reduce boilerplate<br>
✅ <strong>Added</strong>: Context immutability clarification<br>
✅ <strong>Added</strong>: Production reliability safeguards  </p>
<p>📋 <strong>Deferred</strong>: Plugin architecture, circuit breakers, advanced features</p>
<p>The specification now provides a solid foundation that can be extended incrementally.</p>
<hr>
<hr>
<h2 id="packaging-and-runtime-requirements">Packaging and Runtime Requirements<a aria-hidden="true" class="anchor-heading icon-link" href="#packaging-and-runtime-requirements"></a></h2>
<h3 id="nodejs-support">Node.js Support<a aria-hidden="true" class="anchor-heading icon-link" href="#nodejs-support"></a></h3>
<ul>
<li><strong>Minimum version</strong>: Node.js >=24 (requires <code>AsyncLocalStorage</code> and <code>fs.writev</code>)</li>
<li><strong>Module format</strong>: <strong>Pure ESM</strong> only. All published JS is ES Modules. No CommonJS build.</li>
<li><strong>Package metadata</strong>:
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"@semantic-flow/logging"</span><span class="token punctuation">,</span>
  <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"1.0.0"</span><span class="token punctuation">,</span>
  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"module"</span><span class="token punctuation">,</span>
  <span class="token property">"main"</span><span class="token operator">:</span> <span class="token string">"./dist/index.js"</span><span class="token punctuation">,</span>
  <span class="token property">"module"</span><span class="token operator">:</span> <span class="token string">"./dist/index.js"</span><span class="token punctuation">,</span>
  <span class="token property">"types"</span><span class="token operator">:</span> <span class="token string">"./dist/index.d.ts"</span><span class="token punctuation">,</span>
  <span class="token property">"exports"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"."</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"types"</span><span class="token operator">:</span> <span class="token string">"./dist/index.d.ts"</span><span class="token punctuation">,</span>
      <span class="token property">"import"</span><span class="token operator">:</span> <span class="token string">"./dist/index.js"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"./package.json"</span><span class="token operator">:</span> <span class="token string">"./package.json"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"engines"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"node"</span><span class="token operator">:</span> <span class="token string">">=18.17"</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</li>
</ul>
<h3 id="typescript-configuration">TypeScript Configuration<a aria-hidden="true" class="anchor-heading icon-link" href="#typescript-configuration"></a></h3>
<ul>
<li><strong>Compile ESM-only types</strong>:
<pre class="language-json"><code class="language-json"><span class="token comment">// tsconfig.build.json</span>
<span class="token punctuation">{</span>
  <span class="token property">"compilerOptions"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"module"</span><span class="token operator">:</span> <span class="token string">"ES2022"</span><span class="token punctuation">,</span>
    <span class="token property">"target"</span><span class="token operator">:</span> <span class="token string">"ES2022"</span><span class="token punctuation">,</span>
    <span class="token property">"moduleResolution"</span><span class="token operator">:</span> <span class="token string">"bundler"</span><span class="token punctuation">,</span>
    <span class="token property">"declaration"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"declarationMap"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"emitDeclarationOnly"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"outDir"</span><span class="token operator">:</span> <span class="token string">"dist"</span><span class="token punctuation">,</span>
    <span class="token property">"sourceMap"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"inlineSources"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"verbatimModuleSyntax"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"exactOptionalPropertyTypes"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"lib"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"ES2022"</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"include"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"src"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
</li>
</ul>
<h3 id="runtime-esm-hygiene">Runtime ESM Hygiene<a aria-hidden="true" class="anchor-heading icon-link" href="#runtime-esm-hygiene"></a></h3>
<ul>
<li><strong>No <code>require()</code></strong>: Use <code>import</code>/<code>import()</code> everywhere</li>
<li><strong>Replace <code>__dirname/__filename</code></strong>:
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> fileURLToPath <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"node:url"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> dirname <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"node:path"</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> __filename <span class="token operator">=</span> <span class="token function">fileURLToPath</span><span class="token punctuation">(</span><span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> __dirname <span class="token operator">=</span> <span class="token function">dirname</span><span class="token punctuation">(</span>__filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</li>
<li><strong>JSON imports</strong>:
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports">schema</span> <span class="token keyword module">from</span> <span class="token string">"./schema.json"</span> <span class="token keyword">with</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">"json"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
</li>
<li><strong>CLI entry point</strong>:
<pre class="language-javascript"><code class="language-javascript"><span class="token hashbang comment">#!/usr/bin/env node</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> run <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../dist/cli.js'</span><span class="token punctuation">;</span>
<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</li>
</ul>
<h3 id="consumer-requirements">Consumer Requirements<a aria-hidden="true" class="anchor-heading icon-link" href="#consumer-requirements"></a></h3>
<ul>
<li><strong>Pure ESM consumers</strong>: Standard <code>import</code> statements</li>
<li><strong>CommonJS consumers</strong>: Must use dynamic <code>import('@semantic-flow/logging')</code></li>
<li><strong>Tree-shaking</strong>: Channels kept in separate files for optimal bundling</li>
</ul>
<h3 id="testing-vitest">Testing (Vitest)<a aria-hidden="true" class="anchor-heading icon-link" href="#testing-vitest"></a></h3>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// vitest.config.ts</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> defineConfig <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest/config'</span><span class="token punctuation">;</span>
<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  test<span class="token operator">:</span> <span class="token punctuation">{</span>
    environment<span class="token operator">:</span> <span class="token string">'node'</span><span class="token punctuation">,</span>
    isolate<span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="cicd-requirements">CI/CD Requirements<a aria-hidden="true" class="anchor-heading icon-link" href="#cicd-requirements"></a></h3>
<ul>
<li><strong>JSON Lines validation</strong>: Lint commit examples to ensure valid JSONL with newline at end</li>
<li><strong>Console hygiene</strong>: Enforce no <code>console.log</code> in src except inside <code>ConsoleChannel</code> or emergency fallback</li>
<li><strong>ESM purity check</strong>: Block accidental CJS fields in package.json or <code>*.cjs</code> files in dist/</li>
<li><strong>Type checking</strong>: Ensure all examples compile without errors</li>
<li><strong>Performance benchmarks</strong>: Automated benchmarks comparing against previous versions</li>
</ul>
<h3 id="build-tool-configuration">Build Tool Configuration<a aria-hidden="true" class="anchor-heading icon-link" href="#build-tool-configuration"></a></h3>
<p><strong>TypeScript Compiler (tsc)</strong>:</p>
<pre class="language-bash"><code class="language-bash">tsc --project tsconfig.build.json
</code></pre>
<p><strong>tsup</strong>:</p>
<pre class="language-bash"><code class="language-bash">tsup src/index.ts --format esm --dts --sourcemap
</code></pre>
<p><strong>Rollup</strong>:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">input</span><span class="token operator">:</span> <span class="token string">'src/index.ts'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">file</span><span class="token operator">:</span> <span class="token string">'dist/index.js'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'esm'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">sourcemap</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p><strong>esbuild</strong>:</p>
<pre class="language-javascript"><code class="language-javascript">esbuild <span class="token operator">--</span>bundle src<span class="token operator">/</span>index<span class="token punctuation">.</span><span class="token property-access">ts</span> <span class="token operator">--</span>format<span class="token operator">=</span>esm <span class="token operator">--</span>outfile<span class="token operator">=</span>dist<span class="token operator">/</span>index<span class="token punctuation">.</span><span class="token property-access">js</span> <span class="token operator">--</span>sourcemap
</code></pre>
<h3 id="optional-runtime-guardrails">Optional Runtime Guardrails<a aria-hidden="true" class="anchor-heading icon-link" href="#optional-runtime-guardrails"></a></h3>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// Add once at package init to catch CJS usage</span>
<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">require</span> <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">throw</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">Error</span></span><span class="token punctuation">(</span><span class="token string">'This package is ESM-only. Use import().'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="todo">TODO<a aria-hidden="true" class="anchor-heading icon-link" href="#todo"></a></h2>
<h3 id="phase-1-core-infrastructure--complete">Phase 1: Core Infrastructure ✅ COMPLETE<a aria-hidden="true" class="anchor-heading icon-link" href="#phase-1-core-infrastructure--complete"></a></h3>
<p>[x] Create the <code>@semantic-flow/logging</code> package structure (directories, <code>package.json</code>, <code>tsconfig.json</code>).
[x] Implement type definitions and interfaces in <code>shared/logging/src/core/types.ts</code>.
[x] Implement error types and factory in <code>shared/logging/src/errors/types.ts</code> and <code>shared/logging/src/errors/factory.ts</code>.
[x] Implement the <code>ConsoleChannel</code> and <code>LogChannel</code> interface.
[x] Implement the core <code>Logger</code> interface and basic <code>LoggerImpl</code>.
[x] Implement the configuration system.
[x] Implement main exports and factory functions.
[x] Implement unit tests for core functionality.
[x] Developer documentation created in <code>documentation/dev.logging-and-error-handling.md</code>.</p>
<h3 id="phase-1-enhancement-function-name-capture--complete">Phase 1 Enhancement: Function Name Capture ✅ COMPLETE<a aria-hidden="true" class="anchor-heading icon-link" href="#phase-1-enhancement-function-name-capture--complete"></a></h3>
<p>[x] Implement automatic function/method name capture in log context.
[x] Add configuration option to enable/disable function name capture.
[x] Update developer documentation with function name capture feature.
[x] Add unit tests for function name capture.</p>
<p><strong>Implementation Details:</strong></p>
<ul>
<li>Added <code>function?: string</code> field to <a href="/sflo/shared/logging/src/core/types.ts:22"><code>LogContext</code></a> interface</li>
<li>Added <code>captureFunctionName: boolean</code> to <code>autoContext</code> configuration (default: <code>NODE_ENV !== 'production'</code>)</li>
<li>Implemented stack trace parsing in <a href="/sflo/shared/logging/src/utils/stack-trace.ts:1"><code>shared/logging/src/utils/stack-trace.ts</code></a></li>
<li>Integrated capture into <a href="/sflo/shared/logging/src/core/logger.ts:137"><code>LoggerImpl.log()</code></a> method</li>
<li>Updated <a href="/sflo/documentation/dev.logging-and-error-handling.md:1"><code>documentation/dev.logging-and-error-handling.md</code></a> with comprehensive documentation</li>
<li>Added environment variable <code>SF_LOG_AUTO_CONTEXT_CAPTURE_FUNCTION_NAME</code></li>
<li>All 11 unit tests passing in <a href="/sflo/shared/logging/src/__tests__/core.test.ts:1"><code>shared/logging/src/__tests__/core.test.ts</code></a></li>
</ul>
<p><strong>Performance Considerations:</strong></p>
<ul>
<li>Function name capture is environment-aware (disabled in production by default)</li>
<li>Uses stack trace parsing which has a measurable performance cost</li>
<li>Can be explicitly enabled/disabled via configuration</li>
<li>Skips correct number of stack frames to capture the actual calling function</li>
</ul>
<h3 id="phase-2-advanced-features-planned">Phase 2: Advanced Features (Planned)<a aria-hidden="true" class="anchor-heading icon-link" href="#phase-2-advanced-features-planned"></a></h3>
<p>[ ] File channel with rotation
[ ] Monitoring channel (Sentry)
[ ] Unified error handling (capture + recovery)
[ ] Performance tracking enhancements
[ ] Integration tests</p>
<h2 id="decision">Decision<a aria-hidden="true" class="anchor-heading icon-link" href="#decision"></a></h2>
<ul>
<li>modern ESM only, targeting NodeJS >=24</li>
</ul>
<h2 id="summary">Summary<a aria-hidden="true" class="anchor-heading icon-link" href="#summary"></a></h2>
<p>Phase 1: Core Infrastructure for the Shared Logging and Error Handling System (<code>@semantic-flow/logging</code>) is complete, following the specification in <a href="/sflo/documentation/task.2025-11-04-shared-logging-and-errorhandling.md:1"><code>documentation/task.2025-11-04-shared-logging-and-errorhandling.md</code></a>.</p>
<h2 id="phase-1-accomplishments">Phase 1 Accomplishments<a aria-hidden="true" class="anchor-heading icon-link" href="#phase-1-accomplishments"></a></h2>
<ol>
<li><strong>Package Setup:</strong> Created the <code>shared/logging/</code> package structure, including <code>package.json</code> and <code>tsconfig.json</code> configured for Pure ESM and Node.js >=18.17.</li>
<li><strong>Core Types:</strong> Implemented all core types and interfaces in <a href="/sflo/shared/logging/src/core/types.ts:1"><code>shared/logging/src/core/types.ts</code></a>, including <code>LogLevel</code>, <code>LogEntry</code>, <code>LogContext</code>, <code>LogChannel</code>, and <code>LoggerConfig</code>.</li>
<li><strong>Error Handling:</strong> Implemented the base <a href="/sflo/shared/logging/src/errors/types.ts:4"><code>SemanticFlowError</code></a> class and the <code>createErrorType</code> factory function in <a href="/sflo/shared/logging/src/errors/types.ts:1"><code>shared/logging/src/errors/types.ts</code></a>.</li>
<li><strong>Configuration:</strong> Implemented the configuration schema, default values, and the <code>ConfigLoader</code> class with deep merging and log level parsing in <code>shared/logging/src/config/</code>.</li>
<li><strong>Console Channel:</strong> Implemented the synchronous <a href="/sflo/shared/logging/src/channels/console.ts:9"><code>ConsoleChannel</code></a> and necessary formatting utilities (<code>safeStringify</code>, <code>stripAnsi</code>, <code>formatCritical</code>) in <a href="/sflo/shared/logging/src/channels/console.ts:1"><code>shared/logging/src/channels/console.ts</code></a> and <a href="/sflo/shared/logging/src/core/formatters.ts:1"><code>shared/logging/src/core/formatters.ts</code></a>.</li>
<li><strong>Core Logger:</strong> Implemented the <a href="/sflo/shared/logging/src/core/logger.ts:23"><code>Logger</code></a> interface and <a href="/sflo/shared/logging/src/core/logger.ts:91"><code>LoggerImpl</code></a> class, including auto-context generation, channel dispatch, and basic timer functionality.</li>
<li><strong>Context Management:</strong> Implemented the <a href="/sflo/shared/logging/src/core/context.ts:12"><code>ContextManager</code></a> using <code>AsyncLocalStorage</code> for context propagation.</li>
<li><strong>Factory Functions:</strong> Implemented the singleton pattern (<code>initLogger</code>, <code>getLogger</code>) and specialized factory functions (<code>createCliLogger</code>, <code>createServiceLogger</code>) in <a href="/sflo/shared/logging/src/core/logger.ts:1"><code>shared/logging/src/core/logger.ts</code></a>.</li>
<li><strong>Exports:</strong> Consolidated all public exports in <a href="/sflo/shared/logging/src/index.ts:1"><code>shared/logging/src/index.ts</code></a>.</li>
<li><strong>Unit Tests:</strong> Implemented core unit tests in <a href="/sflo/shared/logging/src/__tests__/core.test.ts:1"><code>shared/logging/src/__tests__/core.test.ts</code></a> using a <code>MockLogger</code> utility, covering singleton behavior, context propagation, and error handling.</li>
</ol>
<h2 id="functionmethod-name-capture-addressed-all-coderabbit-suggestions-and-integrated-the-logging-system-into-sflo-host">function/method name capture, addressed all CodeRabbit suggestions, and integrated the logging system into sflo-host<a aria-hidden="true" class="anchor-heading icon-link" href="#functionmethod-name-capture-addressed-all-coderabbit-suggestions-and-integrated-the-logging-system-into-sflo-host"></a></h2>
<h3 id="1-function-name-capture-feature-">1. Function Name Capture Feature ✅<a aria-hidden="true" class="anchor-heading icon-link" href="#1-function-name-capture-feature-"></a></h3>
<ul>
<li>Added <a href="/sflo/shared/logging/src/core/types.ts:22"><code>function?: string</code></a> field to <code>LogContext</code></li>
<li>Implemented stack trace parsing in <a href="/sflo/shared/logging/src/utils/stack-trace.ts:1"><code>shared/logging/src/utils/stack-trace.ts</code></a></li>
<li>Integrated into <a href="/sflo/shared/logging/src/core/logger.ts:139"><code>LoggerImpl.log()</code></a> with environment-aware defaults</li>
<li>Comprehensive documentation in <a href="/sflo/documentation/dev.logging-and-error-handling.md:108"><code>documentation/dev.logging-and-error-handling.md</code></a></li>
</ul>
<h3 id="2-coderabbit-critical-fixes-">2. CodeRabbit Critical Fixes ✅<a aria-hidden="true" class="anchor-heading icon-link" href="#2-coderabbit-critical-fixes-"></a></h3>
<ol>
<li><strong>Channel Sharing</strong> - Fixed resource leak where child loggers created duplicate channels</li>
<li><strong>Async Logger Cleanup</strong> - Made <code>initLogger()</code> async to properly await channel closure</li>
<li><strong>Test Reset Cleanup</strong> - Made <code>__resetLoggerForTests()</code> async with proper channel cleanup</li>
<li><strong>CLI Tool Name Safety</strong> - Added try-catch for <code>fileURLToPath()</code> edge cases</li>
<li><strong>Test Config Isolation</strong> - Fixed <code>createTestConfig()</code> to return deep copy</li>
<li><strong>Race Condition Fix</strong> - Fixed <code>waitForLogs()</code> with proper timeout cleanup</li>
<li><strong>Redaction Logic Fix</strong> - Fixed critical bug using <code>JSON.stringify</code> replacer correctly</li>
<li><strong>DoS Protection</strong> - Added <code>MAX_CTX * 2</code> upper bound for log entries</li>
<li><strong>Schema Validation</strong> - Added minimum constraints for <code>bufferSize</code>/<code>flushInterval</code></li>
<li><strong>Comment Clarity</strong> - Fixed misleading async buffering comment</li>
<li><strong>Code Cleanup</strong> - Removed unused <code>logs</code> property from <code>MockLogger</code></li>
</ol>
<h3 id="3-sflo-host-integration-">3. SFLO Host Integration ✅<a aria-hidden="true" class="anchor-heading icon-link" href="#3-sflo-host-integration-"></a></h3>
<p><strong>Updated Files:</strong></p>
<ul>
<li><a href="/sflo/sflo-host/package.json:15"><code>sflo-host/package.json</code></a> - Added <code>@semantic-flow/logging</code> dependency</li>
<li><a href="/sflo/sflo-host/src/index.ts:1"><code>sflo-host/src/index.ts</code></a> - Integrated logging system:
<ul>
<li>Replaced Fastify's built-in logger with <code>@semantic-flow/logging</code></li>
<li>Added component-scoped logger using <code>getComponentLogger(import.meta.url)</code></li>
<li>Initialized logger at startup with environment-aware configuration</li>
<li>Added graceful shutdown handlers for SIGTERM/SIGINT</li>
<li>Replaced all <code>app.log</code> calls with structured logging using <code>metadata</code> field</li>
<li>Added proper error handling with <code>logger.fatal()</code></li>
</ul>
</li>
</ul>
<p><strong>Integration Features:</strong></p>
<ul>
<li>Environment-aware log levels (DEBUG in dev, INFO in prod)</li>
<li>Pretty formatting in development, JSON in production</li>
<li>Component name automatically captured as 'index'</li>
<li>Graceful shutdown with log flushing</li>
<li>Structured logging with metadata for all application events</li>
</ul>
<h3 id="test-results-">Test Results ✅<a aria-hidden="true" class="anchor-heading icon-link" href="#test-results-"></a></h3>
<p>All 11 unit tests passing in <a href="/sflo/shared/logging/src/__tests__/core.test.ts:1"><code>shared/logging/src/__tests__/core.test.ts</code></a></p>
<h3 id="typescript-compilation-">TypeScript Compilation ✅<a aria-hidden="true" class="anchor-heading icon-link" href="#typescript-compilation-"></a></h3>
<ul>
<li>Logging package builds successfully</li>
<li>SFLO Host compiles without errors</li>
<li>All workspace dependencies linked correctly</li>
</ul>
<p>The <code>@semantic-flow/logging</code> package is now production-ready and fully integrated into the SFLO Host application!</p>